# Lab 5 Integration and SOA - Project Report

## 1. EIP Diagram (Before)

The starter code incorporates an atomic integer generator which, based on whether the generated number is even or odd, 
uses a Router pattern to separate them into two channels: the Publish-Subscribe Channel (`evenChannel`) and the Direct 
Channel (`oddChannel`).

- **`evenChannel` Flow:** The output from the router passes through the `evenChannel`. This channel then goes through a 
Transformer and a Handler which simply logs the output. In addition to the numbers arriving via the router, this channel
also periodically receives random negative numbers generated by a separate process, the `sendNumber` method.


- **`oddChannel` Flow:** The odd numbers from the atomic generator are sent to the Direct Channel (`oddChannel`). However,
its output is connected to a Filter which is configured to only allow even numbers to pass through. Consequently, no 
output will be obtained from this specific flow. Furthermore, a service named `SomeService` also consumes from the 
`oddChannel`'s output. Since `oddChannel` is a Direct Channel, its output will be distributed equally between the filter 
flow and the `SomeService` flow. The service processes these messages and returns them to the log.


- **Isolated Channel:** Finally, there is an isolated `DiscardChannel` with a dedicated Handler that logs any messages it
receives.

### Diagram
![EIP_IncorrectVersion.png](diagrams/before.png)

---

## 2. What Was Wrong

Explain the bugs you found in the starter code:

**Bug 1**: 
- **What was the problem?** The log output corresponding to the Odd Handler was entirely missing. 
- **Why did it happen?** This occurs because the `oddFlow` Filter only receives odd numbers (routed from `myFlow`), 
but it is configured to only permit even numbers (`p % 2 == 0`). Since no messages satisfy the condition, the flow is 
blocked, and no output reaches the handler.
- **How did you fix it?** Assuming the input stream (from the Router) guarantees odd numbers, the simplest solution is
to remove the Filter entirely. Alternatively, if validation was required due to untrusted input, we would invert the 
filter condition to allow odd values (`p % 2 != 0`).
  
**Bug 2**:
-  **What was the second problem?** The log output corresponding to the Service Activator (`SomeService`) only showed 
half the odd numbers it was supposed to receive, effectively skipping every other message.
- **Why did it happen?** The `oddChannel` is, by default, a Direct Channel in Spring Integration. Since it has two
consumers subscribed to its output (the `oddFlow` with the filter, and the `SomeService` Service Activator), the Direct
Channel delivers the message to only one consumer per message. Consequently, one consumer receives the message, and the 
other misses it.
- **How did you fix it?** The channel had to be converted from a Direct Channel into a Publish-Subscribe Channel. This 
configuration ensures that every message sent to the channel is delivered to all subscribed components simultaneously,
preventing message loss and allowing both the `oddFlow` and the `SomeService` to receive every odd number.

**Bug 3**: 
- **What was the third problem?** The Even Handler log output contained negative random numbers (both even and odd),
when it should only process the even numbers.
- **Why did it happen?** This error occurred because the `SendNumber` Messaging Gateway was configured with
`@Gateway(requestChannel = "evenChannel")`. The scheduled task, which generates the random negative numbers, injected 
them directly into the `evenChannel`. This bypassed the main Router component, meaning that the `evenChannel` received 
messages that were not necessarily even (and were not part of the primary flow's logic)
- **How did you fix it?** To ensure all numbers are correctly routed, the `SendNumber` Gateway was reconfigured to send
messages to a new auxiliary Input Channel at the very beginning of the overall integration flow. This new channel is 
then connected to the main Router, ensuring that all input messages (from the atomic generator and the scheduled task)
are subjected to the parity check and routed correctly.

---

## 3. What You Learned

Write a few sentences about:

- What you learned about Enterprise Integration Patterns
   - I've learned that EIPs are an efficient and straightforward tool for designing and building distributed 
  applications. I also learned how simple it is to integrate EIPs with Spring Boot to create a system that might seem
  complex at first glance, doing so in an organized manner and with only a few lines of code.
- How Spring Integration works
  - In Spring Boot, these patterns can be easily implemented using Integration Flows (`integrationFlow`). These flows 
  allow you to string together different components. The various parts of the system are declared and connected using 
  `@Bean` definitions for channels (e.g., `PublishSubscribeChannel`, `DirectChannel`) and components (e.g., `Source`, 
  `Gateway`), and Service Annotations (like `@ServiceActivator`) to link business logic to specific channels.
- What was challenging and how you solved it
  - The main challenge was the discrepancy between the expected system behavior and the actual output generated by the 
  code. Despite being a short code, the existence of multiple interconnected flows complicated the initial understanding
  of its logic, particularly how messages were distributed and consumed.
  - The solution was to model the real, executing system. By creating the EIP Diagram of the "erroneous" code version, 
  I could accurately represent the program's current behavior. This visual understanding helped me find the issues, such
  as the Direct Channel's load-balancing behavior and the bypassed Router, and make the necessary modifications to align
  the system with the desired architectural model.
---

## 4. AI Disclosure

**Did you use AI tools?** (ChatGPT, Copilot, Claude, etc.)

- If YES: Which tools? What did they help with? What did you do yourself?
  - I only used Gemini to translate this report.
- If NO: Write "No AI tools were used."

**Important**: Explain your own understanding of the code and patterns, even if AI helped you write it.

---

## Additional Notes

Any other comments or observations about the assignment.
